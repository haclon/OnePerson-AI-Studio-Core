# 规则标准化分析：通用层 vs 定制层

> **目标**：将 BOQ 项目的 AI 协作规则解构为可复用的"通用核心"和"项目定制"两层，实现 1 分钟内配置到任意新项目。
> **分析人**：PRD 需求分析助理  
> **日期**：2025-12-26

---

## 一、核心组件拆解

当前 BOQ 项目的 AI 协作体系由 3 个核心组件构成：

### 1️⃣ 诊断模式 (`?` 命令)
**位置**：`.cursorrules` 第 4.1-4.4 节

### 2️⃣ 多角色 MDC 规则
**位置**：`.cursor/rules/*.mdc` (6 个文件)

### 3️⃣ 模型选择策略
**位置**：`.cursorrules` 第 5-7 节

---

## 二、逐组件标准化分析

### 📋 组件 1：诊断模式 (`?` 命令)

#### 当前实现（BOQ 项目）

```markdown
当用户输入以 **`?`** 或 **`/task`** 开头时，AI 必须进入"任务诊断模式"：

**输出格式**：`[任务类型] 推荐模型 + 推荐Agent (简短原因)`

**示例**：
- `? 加个字段` → `[写代码] GPT-5.2 + BE-API与数据库 (后端字段改动)`
- `? 这个需求怎么拆` → `[讨论] Sonnet 4.5 + Spec-平台架构师 (需求澄清)`
```

#### 标准化拆解

| 元素 | 类型 | 内容 | 说明 |
|------|------|------|------|
| **触发符号** | ✅ 通用 | `?` 或 `/task` | 所有项目通用 |
| **输出格式** | ✅ 通用 | `[任务类型] 推荐模型 + 推荐Agent (简短原因)` | 固定模板 |
| **任务类型列表** | ✅ 通用 | 写代码、讨论、批量、Bug | 跨项目通用 |
| **Agent 名称** | 🔧 定制 | `BE-API与数据库` | 可替换为通用名 `BE-后端开发` |
| **示例说明** | 🔧 定制 | "后端字段改动" | 需要替换为项目无关的描述 |

#### 通用化方案

**通用层模板**：
```markdown
### 诊断模式

当用户输入 `?` 或 `/task` 开头时，AI 进入任务诊断模式：

**输出格式**：`[任务类型] 推荐模型 + 推荐Agent (简短原因)`

**任务类型**：
- [写代码] - 实现功能、修改逻辑
- [讨论] - 需求澄清、方案设计
- [批量] - 重复性机械操作
- [Bug] - 问题定位与修复
- [文档] - 编写/更新文档
```

**定制层配置文件** (`project-config.json`)：
```json
{
  "agents": {
    "BE-后端开发": "BE-API与数据库",  // 可选：自定义显示名
    "FE-前端开发": "FE-规范与组件"
  }
}
```

---

### 📋 组件 2：多角色 MDC 规则

#### 当前结构（以 `fe_developer.mdc` 为例）

```yaml
---
description: 当进行前端 Vue 3 页面开发、UI 组件编写、样式调整或 API 调用封装时触发。
globs: frontend/src/**/*.vue, frontend/src/**/*.js, frontend/src/**/*.scss, docs/frontend-guidelines.md
---

# 角色：FE-前端开发专家

你现在的角色是 BOQSE-Web 项目的前端开发专家。你精通 Vue 3, Element Plus 和前端工程化。

## 1. 核心职责
- 编写高质量、可维护的 Vue 3 组件
- 统一 UI/UX 风格，复用 Base 组件
...
```

#### 标准化拆解

| 元素 | 类型 | 说明 |
|------|------|------|
| **description (触发条件)** | ✅ 80% 通用 | "前端页面开发、UI 组件编写"是通用的，"Vue 3"是定制的 |
| **globs (文件路径)** | 🔧 100% 定制 | `frontend/src/**/*.vue` 是 BOQ 项目特定的 |
| **角色名称** | ✅ 通用 | "FE-前端开发专家"跨项目通用 |
| **自我介绍** | 🔧 50% 定制 | "你是 BOQSE-Web 的专家"需参数化 |
| **技术栈描述** | 🔧 100% 定制 | "Vue 3, Element Plus"需替换 |
| **核心职责** | ✅ 70% 通用 | 大部分职责是跨框架通用的 |
| **行为禁忌** | ✅ 80% 通用 | "严禁在组件中直接写 Axios"对应所有前端框架 |
| **工作约束** | 🔧 50% 定制 | "遵循 frontend-guidelines.md"是通用的，具体路径是定制的 |

#### 通用化方案

**通用层模板** (`core/rules/fe_developer.mdc.template`)：

```yaml
---
description: 当进行前端{{FRONTEND_FRAMEWORK}}页面开发、UI组件编写、样式调整或API调用封装时触发。
globs: {{FRONTEND_SRC_PATH}}/**/*.{{FRONTEND_EXT}}, docs/frontend-guidelines.md
---

# 角色：FE-前端开发专家

你现在的角色是 {{PROJECT_NAME}} 项目的前端开发专家。你精通 {{FRONTEND_FRAMEWORK}}, {{UI_LIBRARY}} 和前端工程化。

## 1. 核心职责
- 编写高质量、可维护的{{FRONTEND_FRAMEWORK}}组件
- 统一 UI/UX 风格，复用公共组件
- 封装干净的 API 请求（{{API_DIR}}）
- 处理前端状态管理（{{STATE_MANAGEMENT}}）与路由

## 2. 行为禁忌
- 严禁在页面组件中直接书写HTTP请求（必须走API封装层）
- 严禁绕过{{UI_LIBRARY}}变量强行写死样式值
- 禁止在单个文件中编写超过500行的逻辑

## 3. 工作约束
- 遵循 `docs/frontend-guidelines.md` 的规范
- 使用 {{PREFERRED_MODEL}} 作为主力模型
- 必须使用{{COMMENT_LANGUAGE}}注释
- 涉及API接口字段变更时，必须先主动提醒用户走OpenSpec流程

## 4. 质量标准
- 组件逻辑清晰，Props/参数定义完整
- 样式局部化（scoped/模块化）
- 页面加载/报错状态处理到位
```

**项目配置文件** (`project-config.json`)：

```json
{
  "project": {
    "name": "BOQSE-Web",
    "abbr": "BOQSE"
  },
  "frontend": {
    "framework": "Vue 3",
    "ui_library": "Element Plus",
    "src_path": "frontend/src",
    "extensions": "vue,js,scss",
    "api_dir": "src/api/*",
    "state_management": "Pinia"
  },
  "backend": {
    "framework": "FastAPI",
    "orm": "SQLAlchemy 2.0",
    "src_path": "backend/app"
  },
  "conventions": {
    "comment_language": "中文",
    "encoding": "UTF-8",
    "preferred_model_fe": "GPT-5.2",
    "preferred_model_be": "GPT-5.2"
  }
}
```

---

### 📋 组件 3：模型选择策略

#### 当前实现（BOQ 项目）

```markdown
## 5. 模型能力边界

| 模型 | 擅长 | 不擅长 |
|------|------|--------|
| **Opus 4.5** | 复杂推理、需求澄清、风险评估 | 性价比低，不适合简单任务 |
| **Sonnet 4.5** | 理解需求、写文档、日常讨论 | 不如 Opus 深度推理 |
...

## 6. 模型选择策略（快速参考）

| 我要做什么 | 推荐模型 | 为什么 |
|-----------|----------|--------|
| 讨论需求/理清思路 | **Sonnet 4.5** | 理解能力强 |
...
```

#### 标准化拆解

| 元素 | 类型 | 说明 |
|------|------|------|
| **模型能力边界表** | ✅ 100% 通用 | 与项目无关，纯粹是模型特性 |
| **模型选择对照表** | ✅ 100% 通用 | 任务类型跨项目通用 |
| **任务大小判断标准** | ✅ 100% 通用 | 文件数量/代码行数是普适的 |
| **推荐工作流** | ✅ 100% 通用 | "想清楚→写代码"适用所有项目 |

#### 通用化方案

**结论**：模型选择策略可以**完整复用**，无需定制化。

唯一需要注意的是**模型定价数据**应该独立维护在一个可更新的文件中（如 `model-matrix.json`），因为定价会随时间变化。

---

## 三、`.cursorrules` 完整拆解

### 第 1 节：项目概述

| 行号 | 内容 | 类型 | 处理方式 |
|------|------|------|----------|
| 10 | 系统名称：BOQ清单数据提取... | 🔧 定制 | 参数化：`{{PROJECT_FULL_NAME}}` |
| 11 | 项目缩写：BOQSE-Web | 🔧 定制 | 参数化：`{{PROJECT_ABBR}}` |
| 12 | 技术栈：Vue 3 + Element Plus + ... | 🔧 定制 | 参数化：`{{TECH_STACK}}` |
| 13 | 支持的计价软件：... | 🔧 定制 | **删除**（业务特定信息） |
| 14 | 适用场景：... | 🔧 定制 | **删除**（业务特定信息） |
| 15 | 核心功能：... | 🔧 定制 | **删除**（业务特定信息） |

**通用化建议**：
- 保留：系统名称、项目缩写、技术栈
- 删除：业务背景、功能列表（这些应该在项目自己的 README 中）

### 第 2 节：通用开发原则

| 行号 | 内容 | 类型 |
|------|------|------|
| 19-25 | 编码格式、注释语言、增量修改... | ✅ 100% 通用 |

**结论**：完整保留。

### 第 3 节：业务术语表

| 行号 | 内容 | 类型 |
|------|------|------|
| 29-78 | 清单、定额、签证单、枚举值... | 🔧 100% 定制 |

**结论**：**整节删除**，移至 `docs/glossary.md`（项目特定文档）。

### 第 4 节：AI 行为规则

| 子节 | 内容 | 类型 |
|------|------|------|
| 4.1 | 诊断指令约定 | ✅ 90% 通用 |
| 4.2 | 自动诊断流程 | ✅ 100% 通用 |
| 4.3 | 模型不匹配提醒 | ✅ 100% 通用 |
| 4.4 | 大改动提醒 | ✅ 100% 通用 |

**结论**：4.1 需要去除示例中的项目特定术语（如"加个字段"改为通用描述），其余完整保留。

### 第 5-7 节：模型选择策略

| 节 | 内容 | 类型 |
|------|------|------|
| 5 | 模型能力边界 | ✅ 100% 通用 |
| 6 | 模型选择策略 | ✅ 100% 通用 |
| 7 | Agent 角色与模型匹配 | ✅ 100% 通用 |

**结论**：完整保留。

### 第 8 节：工单模板

| 行号 | 内容 | 类型 |
|------|------|------|
| 174-183 | 【目标】【范围】【验收标准】 | ✅ 100% 通用 |

**结论**：完整保留。

### 第 9 节：OpenSpec 流程

| 行号 | 内容 | 类型 |
|------|------|------|
| 187-195 | OpenSpec 触发条件与流程 | ✅ 100% 通用 |

**结论**：完整保留。

### 第 10 节：相关文档

| 行号 | 内容 | 类型 |
|------|------|------|
| 199-208 | frontend-guidelines.md 等 | ✅ 80% 通用 |

**结论**：保留文档列表结构，但文档名称可参数化（如 `{{FRONTEND_GUIDELINE_PATH}}`）。

---

## 四、标准化总结

### 🎯 通用层内容（可直接复用）

| 组件 | 占比 | 内容 |
|------|------|------|
| 诊断模式 (`?` 命令) | 90% | 触发符号、输出格式、任务类型 |
| 模型选择策略 | 100% | 能力边界、对照表、工作流 |
| OpenSpec 流程 | 100% | 触发条件、4 阶段流程 |
| 通用开发原则 | 100% | 编码格式、注释规范、增量修改 |
| 工单模板 | 100% | 【目标】【范围】【验收标准】 |
| Agent 角色职责定义 | 70% | PRD/Spec/FE/BE/QA/Batch 的通用职责 |

### 🔧 定制层内容（需参数化）

| 组件 | 参数数量 | 关键参数 |
|------|----------|----------|
| 项目概述 | 3 个 | `PROJECT_NAME`, `PROJECT_ABBR`, `TECH_STACK` |
| MDC 规则 - description | 2 个/角色 | `FRONTEND_FRAMEWORK`, `BACKEND_FRAMEWORK` |
| MDC 规则 - globs | 5 个/角色 | `FRONTEND_SRC_PATH`, `BACKEND_SRC_PATH`, 文件扩展名 |
| 技术栈特定术语 | 10+ 个 | `UI_LIBRARY`, `STATE_MANAGEMENT`, `ORM`, `API_DIR` |
| 语言与编码规范 | 2 个 | `COMMENT_LANGUAGE`, `ENCODING` |

### ❌ 需删除内容（项目特定业务）

| 内容 | 原因 |
|------|------|
| 第 3 节：业务术语表 | BOQ 行业特定术语（清单、定额） |
| 项目概述中的"适用场景" | 业务背景，不应在通用规则中 |
| 项目概述中的"核心功能" | 功能列表，应在 README 中 |

---

## 五、实现方案：1 分钟配置流程

### 方案 A：交互式 CLI 工具（推荐）

**用户操作**：
```bash
$ npx oneperson-ai-studio init

🚀 OnePerson AI Studio - 项目初始化
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

❓ 项目名称（全称）：BOQ清单数据提取与标准化Web应用
❓ 项目缩写（英文）：BOQSE
❓ 前端框架：
   1. Vue 3
   2. React 18
   3. Angular 16
   4. 其他
👉 选择: 1

❓ UI 库：
   1. Element Plus
   2. Ant Design Vue
   3. Vuetify
👉 选择: 1

❓ 后端框架：
   1. FastAPI (Python)
   2. Express (Node.js)
   3. Gin (Go)
   4. Spring Boot (Java)
👉 选择: 1

❓ 注释语言：
   1. 中文
   2. English
👉 选择: 1

✅ 配置生成中...
✅ .cursorrules 已生成
✅ .cursor/rules/ 已创建（6 个 .mdc 文件）
✅ docs/ 目录结构已创建
✅ openspec/ 已初始化

🎉 完成！用小助手试试：? 我想加个登录功能
```

**耗时**：约 40 秒（含用户输入时间）

---

### 方案 B：配置文件驱动（适合批量创建）

**用户操作**：
1. 创建 `ai-studio-config.json`：
```json
{
  "project": {
    "name": "我的电商平台",
    "abbr": "MyShop"
  },
  "stack": {
    "frontend": "Vue 3 + Element Plus",
    "backend": "FastAPI + SQLAlchemy"
  },
  "conventions": {
    "comment_language": "中文"
  }
}
```

2. 运行：
```bash
$ npx oneperson-ai-studio init --config ai-studio-config.json
```

**耗时**：约 10 秒

---

### 方案 C：AI 辅助初始化（最智能）

**用户操作**：
```bash
$ ? 这是个新项目，帮我配置 AI 规则
```

**AI 执行流程**：
1. **自动扫描**：
   - 检测到 `package.json` → 识别为 Node.js 项目
   - 检测到 `frontend/src/**/*.vue` → 识别为 Vue 项目
   - 检测到 `backend/app/main.py` → 识别为 FastAPI 项目

2. **智能推断**：
```yaml
推断结果:
  前端: Vue 3 (Composition API)
  UI库: Element Plus (检测到 import { ElButton })
  后端: FastAPI 0.104
  数据库: SQLite (检测到 app.db)
```

3. **确认**：
```
✅ 自动识别完成，以下配置是否正确？
   项目名称: 未知（请输入）
   技术栈: Vue 3 + FastAPI ✅
   注释语言: 中文（根据现有代码判断）✅

按回车确认，或输入修正...
```

4. **生成规则**

**耗时**：约 30 秒

---

## 六、核心参数表（最小配置集）

要实现"1 分钟配置"，最少需要以下参数：

| 参数名 | 用途 | 示例值 | 默认值 |
|--------|------|--------|--------|
| `PROJECT_NAME` | 项目全称 | BOQ清单数据提取Web应用 | - |
| `PROJECT_ABBR` | 项目缩写 | BOQSE | - |
| `FRONTEND_FRAMEWORK` | 前端框架 | Vue 3 | - |
| `UI_LIBRARY` | UI 库 | Element Plus | - |
| `BACKEND_FRAMEWORK` | 后端框架 | FastAPI | - |
| `ORM` | ORM 框架 | SQLAlchemy 2.0 | - |
| `COMMENT_LANGUAGE` | 注释语言 | 中文 | English |
| `FRONTEND_SRC_PATH` | 前端源码路径 | frontend/src | src |
| `BACKEND_SRC_PATH` | 后端源码路径 | backend/app | app |
| `STATE_MANAGEMENT` | 状态管理 | Pinia | - |

**扩展参数**（可选）：
- `DATABASE` (PostgreSQL / MySQL / SQLite)
- `DEPLOYMENT` (Docker / K8s / Serverless)
- `TESTING_FRAMEWORK` (pytest / jest)

---

## 七、验收标准

### ✅ 标准 1：快速配置

- [ ] 新项目初始化耗时 < 1 分钟
- [ ] 配置过程中用户输入次数 ≤ 10 次
- [ ] 生成的规则文件无语法错误

### ✅ 标准 2：跨项目复用

- [ ] 同一套核心规则可用于 Python、Node.js、Go 项目
- [ ] 同一套核心规则可用于 Vue、React、Angular 项目
- [ ] 切换技术栈只需修改配置文件，无需改规则逻辑

### ✅ 标准 3：AI 理解正确

- [ ] 输入 `? 加个登录功能` 能正确推荐模型和 Agent
- [ ] 输入 `? 前端报错了` 能识别为前端问题
- [ ] 输入 `? 批量重命名变量` 能推荐 Grok Code + Batch

### ✅ 标准 4：规则不冲突

- [ ] FE 和 BE 规则不会互相干扰
- [ ] 旧代码不会触发新规则的误报
- [ ] MDC 的 `globs` 精确匹配，无误触发

---

## 八、下一步行动

### 🎯 立即可做（验证可行性）

1. **提取通用模板**
   - 手动创建 `.cursorrules.template` 和 `fe_developer.mdc.template`
   - 用 `{{}}` 标记所有可变参数
   - 在 BOQ 项目中测试替换是否正确

2. **编写参数替换脚本**
   - 简单的 Python/Node.js 脚本
   - 读取配置 JSON，替换模板中的 `{{}}`
   - 输出到目标项目目录

### 🔄 迭代优化（逐步完善）

3. **构建 CLI 工具**
   - 实现交互式问答
   - 自动识别技术栈
   - 一键生成规则

4. **建立适配器库**
   - 为常见技术栈预置配置（Vue 3 + FastAPI、React + Express...）
   - 用户只需选择"模板 ID"即可

---

## 九、风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 参数过多，用户觉得复杂 | 中 | 提供"快速模式"（自动推断）和"专家模式"（完整配置） |
| 模板维护成本高 | 低 | 核心模板数量少（6 个 .mdc + 1 个 .cursorrules） |
| 不同 Cursor 版本兼容性 | 中 | 在文档中注明最低版本要求 |
| AI 对参数化规则理解有误 | 高 | 充分测试，确保 `{{}}` 替换后的规则语义清晰 |

---

## 十、总结

### ✅ 可行性结论

经过深度拆解，**OnePerson-AI-Studio-Core 框架完全可行**，原因：

1. **高通用性**：70%+ 的规则内容无需定制
2. **低参数量**：核心参数仅 10 个
3. **明确边界**：通用层、定制层、删除项清晰可辨
4. **验证简单**：可先在 BOQ 项目手动测试模板替换

### 🎯 核心价值

- **新项目**：1 分钟完成 AI 协作规则配置
- **旧项目**：通过"审计引擎"无损注入规则
- **质量保证**：统一的模型选择策略 + 角色分工
- **成本控制**：避免误用昂贵模型

### 📅 推荐路径

**阶段 1**（本周内）：手动验证
- 提取 `.cursorrules.template` 和 1-2 个 `.mdc.template`
- 在一个新的 Demo 项目中测试替换

**阶段 2**（下周）：脚本自动化
- 编写参数替换脚本
- 建立标准配置文件格式

**阶段 3**（2 周后）：CLI 工具
- 实现交互式初始化
- 集成"审计引擎"（旧项目扫描）

---

**下一步**：请用户确认本分析是否符合预期，并决定从哪个阶段开始实施。

